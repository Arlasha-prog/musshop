{% extends "base.html" %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<style>
  .catalog-page {
    padding-block: 32px 40px;
  }
  .catalog-filters {
    background: #0b0d12;
    background: linear-gradient(140deg, rgba(15,23,42,0.94), rgba(15,23,42,0.72));
    border-radius: 20px;
    padding: 24px 28px;
    box-shadow: 0 30px 60px rgba(8, 11, 21, 0.26);
    border: 1px solid rgba(148, 163, 184, 0.18);
    backdrop-filter: blur(18px);
  }
  .catalog-filters .form-control,
  .catalog-filters .form-select {
    min-height: 48px;
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    background-color: rgba(15, 23, 42, 0.7);
    color: #f8fafc;
  }
  .catalog-filters .form-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(226, 232, 240, 0.75);
    margin-bottom: 6px;
  }
  .catalog-filters .form-control::placeholder {
    color: rgba(203, 213, 225, 0.65);
  }
  .catalog-filters .cat-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin: 0;
  }
  .catalog-filters .pill {
    border-radius: 999px;
    padding: 8px 18px;
    background: rgba(15, 23, 42, 0.55);
    color: rgba(248, 250, 252, 0.86);
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }
  .catalog-filters .pill:hover,
  .catalog-filters .pill.active {
    background: linear-gradient(180deg, rgba(243, 85, 37, 0.95), rgba(207, 62, 21, 0.92));
    color: #fff;
    border-color: rgba(243, 85, 37, 0.45);
  }
  .product-card {
    border: none;
    border-radius: 18px;
    background: #fff;
    box-shadow: 0 20px 46px rgba(15, 23, 42, 0.1);
    padding: 22px;
  }
  .product-card .product-thumb {
    border-radius: 14px;
    overflow: hidden;
  }
  .product-card img {
    border-radius: 14px;
  }
  .product-card h5 a {
    color: #11131d;
    text-decoration: none;
    transition: color 0.2s ease;
  }
  .product-card h5 a:hover {
    color: #f35525;
  }
  .product-card .price {
    font-weight: 700;
    font-size: 1.125rem;
    color: #f35525;
  }
  @media (max-width: 991.98px) {
    .catalog-page {
      padding-block: 24px 32px;
    }
    .catalog-filters {
      padding: 20px 20px 24px;
    }
  }
  @media (max-width: 767.98px) {
    .catalog-filters .pill {
      padding: 8px 14px;
      font-size: 0.95rem;
    }
  }
  @media (max-width: 575.98px) {
    .catalog-filters {
      padding: 18px 16px;
    }
    .catalog-filters .form-control,
    .catalog-filters .form-select {
      min-height: 44px;
    }
    .catalog-filters .cat-pills {
      margin-top: 12px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 4px;
    }
  }
</style>
{% endblock %}

{% block title %}{% if category %}{{ category.name }} — {% endif %}Каталог — MusShop{% endblock %}

{% block page_heading %}
<div class="page-heading header-text">
  <div class="container">
    <div class="row"><div class="col-lg-12">
      <span class="breadcrumb"><a href="{% url 'home' %}">Главная</a> / Каталог{% if category %} / {{ category.name }}{% endif %}</span>
      <h3>{% if category %}{{ category.name }}{% else %}Все товары{% endif %}</h3>
    </div></div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="catalog-page">
  <section class="catalog-filters mb-4">
    <div class="row align-items-end g-3">
      <div class="col-12 col-lg-4">
        <form method="get" class="w-100" role="search">
          {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
          <label for="catalogSearch" class="form-label">Поиск</label>
          <input id="catalogSearch" type="text" name="q" value="{{ query|default:'' }}" class="form-control" placeholder="Найти товар">
        </form>
      </div>
      <div class="col-6 col-lg-3">
        <form method="get" class="w-100">
          {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
          <label for="catalogSort" class="form-label">Сортировка</label>
          <select id="catalogSort" class="form-select" name="sort" onchange="this.form.submit()">
            <option value="">По умолчанию</option>
            <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Цена: по возрастанию</option>
            <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Цена: по убыванию</option>
            <option value="new" {% if sort == 'new' %}selected{% endif %}>Новые</option>
          </select>
        </form>
      </div>
      <div class="col-12 col-lg-5">
        <span class="form-label d-inline-block mb-2">Категории</span>
        <div class="cat-pills justify-content-lg-end" role="group" aria-label="Категории каталога">
          <a class="pill {% if not category %}active{% endif %}" href="{% url 'shop_all' %}">Все</a>
          {% for cat in categories %}
            <a class="pill {% if category and category.id == cat.id %}active{% endif %}" href="{% url 'category' cat.slug %}">{{ cat.name }}</a>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>

  <div class="row g-4">
    {% for product in products %}
      <div class="col-sm-6 col-lg-4">
        <div class="card product-card h-100">
          <div class="product-thumb mb-3">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.title }}">
            {% else %}
              <img src="{% static 'assets/images/property-01.jpg' %}" alt="{{ product.title }}">
            {% endif %}
          </div>
          <span class="text-muted small">{{ product.category.name }}</span>
          <h5 class="mt-1"><a href="{% url 'product' product.slug %}">{{ product.title }}</a></h5>
          <div class="price mt-auto">{{ product.price|floatformat:0 }} ₸</div>
          <div class="d-flex gap-2 mt-3">
            <a class="btn btn-outline-dark" href="{% url 'product' product.slug %}">Подробнее</a>
            <form action="{% url 'cart_add' product.slug %}" method="post" class="ms-auto">
              {% csrf_token %}
              <input type="hidden" name="qty" value="1">
              <input type="hidden" name="replace" value="0">
              <button class="btn btn-primary" type="submit">В корзину</button>
            </form>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-info">Товары не найдены. Попробуйте изменить параметры поиска.</div>
      </div>
    {% endfor %}
  </div>

  {% if products.has_other_pages %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        {% if products.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ products.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">Назад</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Назад</span></li>
        {% endif %}

        {% for num in products.paginator.page_range %}
          {% if products.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if products.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ products.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}">Вперёд</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Вперёд</span></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
